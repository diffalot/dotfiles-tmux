# tmux plugin manager
#   - install <C-B> <C-I>
#   - update  <C-B> <C-U>
#
##  fix for missing terminfos  #################################################
#
# # test for italic output
#
# ## Levels of a working italicized terminal
#
# - `italics` should be printed in italics in your terminal when you enter
#     `echo -e "\e[3m italics \e[23m"` [1] or
#     `echo -e "\\x1b[3m italics \\x1b[23m"`
# - Programs like `htop` and `tig` should be running in full color, not black
#   and white
# - When you open vim you should see a nice colorscheme in 256 colors
#   todo: Find the command that prints out how many colors vim is using
# - You should be able to repeat all of those tests in `tmux`
# - Once all of those are verified, check if you have fonts inside `nvim` inside
#   `tmux`
#
# `tmux` is stealthy--start it up with a named session and you might find a #0
# session hiding out after you exit.  And don't believe that it's completely
# shut down after you `tmux kill-server`; I run a `killall tmux` right after
# that and let me know `killall` ever fails to report `No matching processes`;
# that just means `killall` is gonna be eating well tonight.
#
# if there's an old `tmux` server running from before you changed the configs,B"
# it's got you old settings on it, and you have no idea if what you put on disk
# is a good setup.--
#
# ## How the different terminal emulators fare at different `TERM` settings
#
# Terminal Emulator Behaviour on macOS with TERM and Color Depth Overrides
#
# - TERM set in application's own preferences
#   - Establish a baseline and record what $TERM has been set to in each case
# - TERM set in tmux `terminal-overrides`
#   - Kill any remainig `tmux` processes and restart
#
# 3. `TRUECOLOR` set in `tmux.conf`
# 4. `terminal-overrides` set for color depth in tmux
# 5. color depth overridden in nvim `init.vim`
# 6. excape code overrides set in `init.vim`
#
# Legend of symbols and marks:
# - `tmux` overrides in `.tmux.conf`
#   - `envTC` - Set Truecolor environment with
#               `set-environment -g COLORTERM "truecolor"``
#   - `orTC`  - Force Truecolor on with
#               `set-option -a terminal-overrides ",*:Tc"`
#   - `orRGB` - Force RGB colors with
#               `set-option -a terminal-overrides ",*:RGB"`
#
#+-------------------------------------------------+---------+------+--------+------+----------+
#| Settings                                        | Display | open | foo in | open | italics  |
#|                                                 |         |      |        |      | in vim   |
#|                                                 | __foo__ | vim  | tmux   | htop | in tmux  |
#+-------------------------------------------------+---------+------+--------+------+----------+
#| Kitty TERM = none = `xterm-kitty`               |         |      |        |      |          |
#| tmux  TERM = none = `screen`                    | yes     | yes  | no     |      |          |
#| tmux  Overrides = envTC, orTC, orRGB            |         |      |        |      |          |
#| nvim  Overrides = not attempted                 |         |      |        |      |          |
#+-------------------------------------------------+---------+------+--------+------+----------+
#| Kitty TERM `xterm-256color` => `xterm-256color` |         |      |        |      | yes, but |
#| tmux  TERM `xterm-256color` => `xterm-256color` |         |      |        |      | Home and |
#| tmux  Overrides = envTC, orTC, orRGB            | yes     | yes  | yes    | yes  | End keys |
#| nvim  Overrides = none                          |         |      |        |      | stopped  |
#|                                                                                  | working  |
#| I thought I'd gotten very lucky with this one for a little while. I thinkthere   |          |
#| is something to using these wrong setting when the ones that have been provided  |          |
#| are at just as wrong.  If I can't get any of these other modes closer, I'll      |          |
#| Probably come back to this one for round three... If those keys are reporting    |          |
#| anything it's probably easier to just map them than all of this.
#
#| Another option suggested by this resule is compiling our own terminfo:
#|
#+-------------------------------------------------+---------+------+--------+------+----------+
#| Kitty TERM = `xterm-kitty` = `xterm-kitty`      |         |      |        |      |          |
#| tmux  TERM = `tmux-256color` = `tmux-256color`  | yes     |      | vim    |no    |   no              |
#| tmux  Overrides = orRGB, envTC, orTC            |         |      |        | color  italics       |          |
#| nvim  Overrides = not attempted                 |         |      |        |      |          |
#+-------------------------------------------------+---------+------+--------+------+----------+
#| Kitty TERM = `xterm-kitty` = `xterm-kitty`      |         |      |        |      |          |
#| tmux  TERM = `tmux-256color` = `tmux-256color`  |         |      |        |      |                   |
#| tmux  Overrides = envTC, orTC,      |         |      |        |                      |          |
#| nvim  Overrides = not attempted                 |         |      |        |      |          |
#+-------------------------------------------------+---------+------+--------+------+----------+
#|                                                 |         |      |        |      |          |
#| Everyone talked about Truecolor a lot and RGB   |         |      |        |
#| very little so, I wanted to see if RGB mattered |                                              |
#+-------------------------------------------------+---------+------+--------+------+----------+
#| Kitty TERM = none = `xterm-kitty`               |         |      |        |      |          |
#| tmux  TERM = none = `screen`                    |         |      |        |      |          |
#| tmux  Overrides =                               |         |      |        |      |          |
#| nvim  Overrides = not attempted                 |         |      |        |      |          |
#|                                                 |         |      |        |      |          |
#+-------------------------------------------------+---------+------+--------+------+----------+
#| Kitty TERM = `screen-256color` = ``             |         |      |        |      |          |
#| tmux  TERM = none = ``                          |         |      |        |      |          |
#| tmux  Overrides = envTC,                        |         |      |        |      |          |
#| nvim  Overrides = not attempted                 |         |      |        |      |          |
#+-------------------------------------------------+---------+------+--------+------+----------+
#| Kitty TERM `xterm-256color`                     |         |      |        |      |          |
#| tmux  TERM `screen-256color`                    |         |      |        |      |          |
#| nvim  Overrides = [envTC, orRGB, orTC]          |         |      |        |      |          |
#+-------------------------------------------------+---------+------+--------+------+----------+
#| Kitty TERM `screen-256color`                    |         |      |        |      |          |
#| tmux  TERM       none                           |         |      |        |      |          |
#| nvim  Overrides  none                           |         |      |        |      |          |
#+-------------------------------------------------+---------+------+--------+------+----------+
#| Kitty TERM `tmux-256color`                      |         |      |        |      |          |
#| tmux  TERM       none                           |         |      |        |      |          |
#| nvim  Overrides  none                           |         |      |        |      |          |
#+-------------------------------------------------+---------+------+--------+------+----------+
#
# Testing Configs (these just have to come after the new-session thing, we'll
# back to the real config soon)

#set-option -g default-terminal "tmux-256color"
#set-option -g default-terminal "tmux-256color-italic"
set-option -g default-terminal "screen-256color"
set-option -ga terminal-overrides ",xterm-kitty:RGB"
set-option -ga terminal-overrides ",xterm-kitty:Tc"
set-option -ga terminal-overrides ",xterm-256color:RGB"
set-option -ga terminal-overrides ",xterm-256color:Tc"
set-option -ga terminal-overrides ",*:RGB"
set-option -ga terminal-overrides ",*:Tc"

#set-option -ga terminal-overrides ""*:Ss=\E[%p1%d q:Se=\E[ q""
#
# [1][https://stackoverflow.com/questions/3494435/vimrc-make-comments-italic]
#
#
# I'm gonna keep the following notes around even I've something working right
# in a terminal that I like.  I'm not counting on it staying like this forever.
#
#                                                                           --
#                                                                        Alice
#                                                                   2021-05-20
#
#  Notes from a Previous Rodeo  ###############################################
#
# despite all the blog posts and miscellaneous info I gleaned from the detrius
# of other people's computing configurations, I just don't know what to believe
# anymore.
#
# I don't know why it works this way. Everyone who said it shouldn't work this
# way acknowledged that it did. And they took action in their disbelief and
# compiled terminfo files, reverse engineering technology that has never
# existed, and we now have the closest thing to proof of the non existence of
# these strange devices: Not one of those blog posts was ever right in the end.
#
# All you have to do to get that weird little terminal app on your phone to
# connect to these strange containerized, networked boxes in full truecolor
# glory, is set everything to pretend to operate at 256 colors and claim to be
# a progream called screen. It's true, here's what I did once I had exhausted
# all other possibilities:
#
#     1. I set the terminal was typing into to `xterm-256color`
#
#     2. One I was on the server it claimed i was merely `xterm` so i set the
#        TERM environment variable to `xterm-256color` and my way to join the
#        tmux session.
#
#     3. Once inside the session I bumped myself up frome `screen` to
#        `screen-256color` to match what tmux hat been configured it was:
#        `screen-256color` and everything has been smooth since then.
#
#        (I guess i messed up the first part of this story... jus                                                    --
#                                                                        Alice
#                                                                   2021-05-12
#
#  And now, here is the config!  ##############################################
#
#  fix for neovim in tmux in st terminal  #####################################
#
# set -as terminal-overrides ',st*:Ss@'
#
#  Fix Undercurl  #############################################################

set -as terminal-overrides ',*:Smulx=\E[4::%p1%dm'  # undercurl support
set -as terminal-overrides ',*:Setulc=\E[58::2::%p1%{65536}%/%d::%p1%{256}%/%{255}%&%d::%p1%{255}%&%d%;m'  # underscore colours - needs tmux-3.0

#  preferences  ###############################################################
#
set -g mouse on                # turn on mouse controls
set -g base-index 1            # start windows numbering at 1
set -g renumber-windows on     # renumber windows when a window is closed
set -g set-titles on           # set terminal title
set -g display-panes-time 800  # slightly longer pane indicators display time
set -g display-time 1000       # slightly longer status messages display time
set -g status-interval 10      # redraw status line every 10 seconds
set -g aggressive-resize       # allow windows attached to two or more clients
set -g pane-base-index 1       # make pane numbering consistent with windows
set -g automatic-rename on     # rename window to reflect current program
#                              # in the same session to have different sizes
#                              # limited by the smallest screen size of the
#                              # clients that are attached to the same window
#
# open new windows and panes with current path
bind '"' split-window -c "#{pane_current_path}"
bind % split-window -h -c "#{pane_current_path}"
bind c new-window -c "#{pane_current_path}"

# spend more time in misc. vi modes
set -g status-keys vi
set-window-option -g mode-keys vi
bind-key -T copy-mode-vi 'v' send -X begin-selection
bind-key -T copy-mode-vi 'y' send -X copy-selection-and-cancel

#  default plugins  ###########################################################
#
set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-sensible'
set -g @plugin 'tmux-plugins/tmux-pain-control'
set -g @plugin 'tmux-plugins/tmux-yank'

# session permanence
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @resurrect-strategy-nvim 'session'
#set -g @resurrect-processes '"~yarn watch"'
set -g @resurrect-processes '"~yarn watch->yarn watch"'

## i3 for tmux
## https://github.com/jabirali/tmux-tilish
set -g @plugin 'jabirali/tmux-tilish'
set -g @plugin 'sunaku/tmux-navigate'
set -g @tilish-navigate 'on'
set -g @tilish-default 'main-vertical'
set -g @tilish-easymode 'on'
#set -g @tilish-prefix 'C-b'

# https://github.com/sainnhe/tmux-fzf
set -g @plugin 'sainnhe/tmux-fzf'

TMUX_FZF_LAUNCH_KEY="C-Space"
#TMUX_FZF_MENU=\
#"Light scheme-tmux day\n"\
#"Dark scheme-tmux\n"\
#"attach session\n/home/alice/.tmux/plugins/tmux-fzf/scripts/session.sh attach\n"\
#"rename window\n/home/alice/.tmux/plugins/tmux-fzf/scripts/window.sh rename\n"
#TMUX_FZF_ORDER="pane|window|session|command|keybinding|process"
TMUX_FZF_OPTIONS="-p -w 62% -h 38% -m"

###############################################################################
# the following are managed by the scheme-tmux script in fish/functions #######

# COLOUR (base16)

# pane border
set-option -g pane-border-style "fg=#efefaa"
set-option -g pane-active-border-style "fg=#64f7cf"

# message text
set-option -g message-style "bg=#6f78a8,fg=#efefaa"

# pane number display
set-option -g display-panes-active-colour "#ff0883"
set-option -g display-panes-colour "#efc3fe"

# clock
set-window-option -g clock-mode-colour "#ef73ee"

# copy mode highligh
set-window-option -g mode-style "fg=#efefaa,bg=#30343b"

# bell
set-window-option -g window-status-bell-style "bg=#ff0883,fg=#64f7cf"

# end script management #######################################################
set -g status-position top
set -g status-justify right
# default statusbar colors

# Night Mode
set-option -g status-style "fg=#afafff,bg=#30343b" ##1f2128"
# default window title colors'
set-window-option -g window-status-style "fg=#efefaa,bold,bg=default"
# active window title colors
set-window-option -g window-status-current-style "fg=#64f7cf,bold,italics,bg=default"

# status left #64f7cf #33c3c3 #efefaa #77e55f #f3c3cf #efc3fe #1f2128 #6f78a8 #eff5ea
set -g status-left-length 200
set -g status-left '#[default]#{?client_prefix,#[fg=#1f2128]#[bg=#ff0883],} ⁂ '
set -ag status-left '#[default,italics]#[fg=#efc3fe]#{?client_prefix,#[default]#[fg=#1f2128]#[bg=#ff0883],}#S:' 
set -ag status-left '#[default]#[fg=#efefaa,bold]#{?client_prefix,#[default]#[fg=#1f2128]#[bg=#ff0883],} #I.'  
set -ag status-left '#[default]#{?client_prefix,#[fg=#1f2128]#[bg=#ff0883],#[fg=#64f7cf,bold,italics]}#P'
set -ag status-left "#[default]#{?client_prefix,#[fg=#1f2128]#[bg=#ff0883],} 》"
#set -ag status-left "#[fg=#64f7cf,bold,italics]#{?client_prefix,#[default]#[fg=#1f2128]#[bg=#ff0883],}#( starship module git_branch; starship module git_status || echo '') "
set -ag status-left "#[fg=#64f7cf,bold,italics]#{?client_prefix,#[default]#[fg=#1f2128]#[bg=#ff0883],}#( cd #{pane_current_path} && echo '  ' && git branch --show-current || echo '') "
set -ag status-left '#[fg=#64f7cf,bold,italics]#{?client_prefix,#[default]#[fg=#1f2128]#[bg=#ff0883],}#(echo -n #{pane_current_path} | sed -e "s/\/Users\/$USER/~/g" | sed -e "s-\(\.*[^/]\)[^/]*/-\1/-g") '
set -ag status-left '#[default]#{?client_prefix,#[default]#[fg=#1f2128]#[bg=#ff0883],}》'

set -g status-right-length 200
set -g status-right '#[default]#[fg=#efc3fe]#{?client_prefix,#[fg=#1f2128]#[bg=#ff0883],}《 ' 
set -ag status-right '#[italics]#{?client_prefix,#[fg=#1f2128]#[bg=#ff0883],}#S:'  
set -ag status-right '#[default]#[fg=#efefaa,bold]#{?client_prefix,#[fg=#1f2128]#[bg=#ff0883],} #I.'  
set -ag status-right '#[fg=#64f7cf,bold,italics]#{?client_prefix,#[fg=#1f2128]#[bg=#ff0883],}#P '
set -ag status-right "#[default]#[fg=#efc3fe]#{?client_prefix,#[fg=#1f2128]#[bg=#ff0883],}⁂ "
#set -ag status-right "#{continuum_status} #{? #("1" = "#(continuum_status)"),#[fg=#efc3fe],#[fg=#ff0883]}"

###############################################################################
# single neovim-remote per session
#set -g @plugin 'carlocab/tmux-nvr'

# session continuation, continuum comes almost last
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @continuum-boot 'on'
set -g @continuum-boot-options 'kitty,fullscreen'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '5'

#bind-key M-j run-shell 'fish ~/.config/fish/functions/journal.fish'

#  tmux plugin manager run config (must be last command)  #####################
run -b '~/.tmux/plugins/tpm/tpm'

# Start up tmux-resurrect so condinuum will work
run-shell ~/.tmux/plugins/tmux-resurrect/resurrect.tmux

#set-environment COLORTERM "truecolor"
###############################################################################
# todo(Alice): find a cross platform (Linux, macOS) (tmux, vim) shared
# clipboard system<F12><F12><F12>
